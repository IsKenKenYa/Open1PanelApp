# 认证管理模块架构设计

## 模块目标

认证管理模块旨在为Open1PanelApp提供安全、可靠、用户友好的身份验证体系，确保：
- 用户身份安全验证
- 会话状态有效管理
- 多因素认证支持
- 安全状态实时检测

## 功能完整性清单

### 基于OpenAPI端点

| 端点 | 方法 | 功能 | 实现状态 | UI状态 |
|------|------|------|---------|--------|
| `/core/auth/captcha` | GET | 获取验证码图片 | ✅ API完成 | ❌ 待开发 |
| `/core/auth/demo` | GET | 检查演示模式 | ✅ API完成 | ❌ 待开发 |
| `/core/auth/issafety` | GET | 获取安全状态 | ✅ API完成 | ❌ 待开发 |
| `/core/auth/language` | GET | 获取系统语言 | ✅ API完成 | ❌ 待开发 |
| `/core/auth/login` | POST | 用户登录 | ✅ API完成 | ❌ 待开发 |
| `/core/auth/logout` | POST | 用户登出 | ✅ API完成 | ❌ 待开发 |
| `/core/auth/mfalogin` | POST | MFA登录 | ✅ API完成 | ❌ 待开发 |
| `/core/auth/setting` | GET | 获取登录设置 | ✅ API完成 | ❌ 待开发 |

### 功能清单

| 功能模块 | 子功能 | 优先级 | 状态 |
|---------|--------|--------|------|
| **登录认证** | 用户名密码登录 | P0 | API完成 |
| | 验证码验证 | P0 | API完成 |
| | MFA多因素认证 | P1 | API完成 |
| | 记住登录状态 | P1 | 待开发 |
| **会话管理** | Token存储与刷新 | P0 | 拦截器完成 |
| | 登出处理 | P0 | API完成 |
| | 会话超时处理 | P1 | 待开发 |
| **安全检测** | 演示模式检测 | P1 | API完成 |
| | 安全状态查询 | P1 | API完成 |
| | 登录失败限制 | P2 | 待开发 |

## 业务流程与交互验证

### 1. 标准登录流程

```
┌─────────────┐     ┌─────────────┐     ┌─────────────┐
│  启动应用   │────▶│  检查Token  │────▶│  Token有效? │
└─────────────┘     └─────────────┘     └──────┬──────┘
                                               │
                    ┌──────────────────────────┴──────┐
                    │ Yes                             │ No
                    ▼                                 ▼
           ┌─────────────┐                   ┌─────────────┐
           │  进入主页   │                   │  显示登录页 │
           └─────────────┘                   └──────┬──────┘
                                                    │
                    ┌───────────────────────────────┘
                    ▼
           ┌─────────────┐     ┌─────────────┐
           │ 获取验证码  │────▶│ 输入凭证    │
           └─────────────┘     └──────┬──────┘
                                       │
                    ┌──────────────────┴──────┐
                    │                         │
                    ▼                         ▼
           ┌─────────────┐           ┌─────────────┐
           │  普通登录   │           │  MFA登录    │
           └──────┬──────┘           └──────┬──────┘
                  │                         │
                  └──────────┬──────────────┘
                             ▼
                    ┌─────────────┐
                    │ 登录成功?   │
                    └──────┬──────┘
                           │
           ┌───────────────┴───────────────┐
           │ Yes                           │ No
           ▼                               ▼
    ┌─────────────┐                 ┌─────────────┐
    │ 存储Token   │                 │ 显示错误    │
    └──────┬──────┘                 └─────────────┘
           │
           ▼
    ┌─────────────┐
    │  进入主页   │
    └─────────────┘
```

### 2. MFA认证流程

```
用户登录 ──▶ 验证用户名密码 ──▶ 检查MFA状态
                                    │
                    ┌───────────────┴───────────────┐
                    │ 已启用                        │ 未启用
                    ▼                               ▼
           ┌─────────────┐                 ┌─────────────┐
           │ 输入MFA码   │                 │ 直接登录    │
           └──────┬──────┘                 └─────────────┘
                  │
                  ▼
           ┌─────────────┐
           │ 验证MFA码   │
           └──────┬──────┘
                  │
           ┌──────┴──────┐
           │ 正确        │ 错误
           ▼             ▼
    ┌─────────────┐ ┌─────────────┐
    │ 登录成功    │ │ 重试/锁定   │
    └─────────────┘ └─────────────┘
```

## 关键边界与异常处理

### 边界条件

| 场景 | 边界值 | 处理方式 |
|------|--------|---------|
| 用户名长度 | 1-64字符 | 前端校验+后端校验 |
| 密码长度 | 6-128字符 | 前端校验+后端校验 |
| MFA码长度 | 6位数字 | 前端格式化输入 |
| 验证码有效期 | 5分钟 | 过期自动刷新 |
| 登录重试次数 | 5次 | 超限锁定账户 |

### 异常处理

| 异常类型 | 错误码 | 处理策略 |
|---------|--------|---------|
| 网络错误 | -1 | 显示重试按钮，自动重连 |
| 认证失败 | 401 | 清除Token，跳转登录页 |
| 账户锁定 | 423 | 显示锁定时间和解锁方式 |
| 验证码错误 | 400 | 刷新验证码，提示重新输入 |
| MFA验证失败 | 401 | 显示剩余重试次数 |
| 演示模式限制 | 403 | 显示演示模式提示 |

## 模块分层与职责

### 架构图

```
┌─────────────────────────────────────────────────────────┐
│                    UI Layer (Pages)                      │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐     │
│  │ LoginPage   │  │ MFADialog   │  │ SplashPage  │     │
│  └─────────────┘  └─────────────┘  └─────────────┘     │
└─────────────────────────────────────────────────────────┘
                          │
                          ▼
┌─────────────────────────────────────────────────────────┐
│                 ViewModel Layer (Providers)              │
│  ┌─────────────────────────────────────────────────┐   │
│  │              AuthProvider                        │   │
│  │  - loginState, user, isLoading, errorMessage    │   │
│  │  - login(), logout(), checkAuth(), refresh()    │   │
│  └─────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────┘
                          │
                          ▼
┌─────────────────────────────────────────────────────────┐
│                  Service Layer                           │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐     │
│  │ AuthService │  │TokenService │  │SessionService│    │
│  └─────────────┘  └─────────────┘  └─────────────┘     │
└─────────────────────────────────────────────────────────┘
                          │
                          ▼
┌─────────────────────────────────────────────────────────┐
│                   API Layer                              │
│  ┌─────────────────────────────────────────────────┐   │
│  │              AuthV2Api                           │   │
│  │  - getCaptcha, login, logout, mfaLogin          │   │
│  │  - checkDemoMode, getSafetyStatus               │   │
│  └─────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────┘
                          │
                          ▼
┌─────────────────────────────────────────────────────────┐
│                 Network Layer                            │
│  ┌─────────────┐  ┌─────────────┐                      │
│  │ DioClient   │  │AuthInterceptor│                     │
│  └─────────────┘  └─────────────┘                      │
└─────────────────────────────────────────────────────────┘
```

### 职责划分

| 层级 | 组件 | 职责 |
|------|------|------|
| **UI层** | LoginPage | 登录表单展示、验证码显示、错误提示 |
| | MFADialog | MFA码输入、验证状态显示 |
| | SplashPage | 启动动画、Token检查、路由决策 |
| **ViewModel层** | AuthProvider | 认证状态管理、业务逻辑协调 |
| **Service层** | AuthService | 认证业务逻辑封装 |
| | TokenService | Token存储、刷新、验证 |
| | SessionService | 会话管理、超时处理 |
| **API层** | AuthV2Api | API调用封装 |
| **Network层** | AuthInterceptor | 请求认证头注入 |

## 数据流设计

### 登录数据流

```
用户输入 ──▶ LoginPage ──▶ AuthProvider.login()
                              │
                              ▼
                        AuthService.login()
                              │
                              ▼
                        AuthV2Api.login()
                              │
                              ▼
                        DioClient.post()
                              │
                              ▼
                        AuthInterceptor.onRequest()
                              │
                              ▼
                        服务器响应
                              │
                              ▼
                        TokenService.saveToken()
                              │
                              ▼
                        AuthProvider.updateState()
                              │
                              ▼
                        Navigator.push(HomePage)
```

### Token刷新数据流

```
API请求 ──▶ AuthInterceptor ──▶ 检查Token有效期
                                    │
                    ┌───────────────┴───────────────┐
                    │ 有效                          │ 即将过期
                    ▼                               ▼
             添加认证头                      TokenService.refresh()
                    │                               │
                    │                               ▼
                    │                        AuthV2Api.refreshToken()
                    │                               │
                    │                               ▼
                    │                        更新存储的Token
                    │                               │
                    └───────────────────────────────┘
                                    │
                                    ▼
                              继续请求
```

## 与现有实现的差距

### 已实现

| 组件 | 文件 | 状态 |
|------|------|------|
| API客户端 | lib/api/v2/auth_v2.dart | ✅ 完成 |
| 认证拦截器 | lib/core/network/interceptors/auth_interceptor.dart | ✅ 完成 |

### 待实现

| 组件 | 优先级 | 预计工作量 |
|------|--------|-----------|
| 数据模型 | P0 | 2小时 |
| AuthProvider | P0 | 4小时 |
| AuthService | P0 | 3小时 |
| TokenService | P0 | 2小时 |
| LoginPage | P0 | 6小时 |
| MFADialog | P1 | 3小时 |
| SplashPage | P0 | 2小时 |
| 单元测试 | P0 | 4小时 |

## 评审记录表

| 日期 | 评审人 | 评审内容 | 结果 | 备注 |
|------|--------|---------|------|------|
| 2026-02-14 | - | 初始架构设计 | 待评审 | - |

---

**文档版本**: 1.0  
**最后更新**: 2026-02-14  
**维护者**: Open1Panel开发团队
